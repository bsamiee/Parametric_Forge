#!/usr/bin/env sh
# Title         : yabairc
# Author        : Bardia Samiee
# Project       : Parametric Forge
# License       : MIT
# Path          : /01.home/00.core/configs/apps/yabai/yabairc
# ----------------------------------------------------------------------------
# Primary yabai window manager configuration
# shellcheck disable=SC1091

set -eu

# --- Sourcing ---------------------------------------------------------------
. "$HOME/.config/yabai/rules.sh"

# --- Scripting Addition -----------------------------------------------------
sudo /opt/homebrew/bin/yabai --load-sa 2>/dev/null && SA_LOADED=true || SA_LOADED=false
yabai -m signal --remove reload_sa >/dev/null 2>&1 || true
[ "$SA_LOADED" = true ] && yabai -m signal --add event=dock_did_restart action="sudo /opt/homebrew/bin/yabai --load-sa" label=reload_sa

# --- Configuration ----------------------------------------------------------

# Core Configuration
yabai -m config window_insertion_point focused \
  window_origin_display cursor

# Layout Configuration
yabai -m config layout bsp \
  split_ratio 0.50 \
  auto_balance on \
  top_padding 4 \
  bottom_padding 4 \
  left_padding 4 \
  right_padding 4 \
  window_gap 4 \
  external_bar all:4:4 \
  menubar_opacity 1.0

# Appearance Configuration
yabai -m config window_opacity on \
  active_window_opacity 0.95 \
  normal_window_opacity 0.80 \
  window_opacity_duration 0.25 \
  window_shadow on \
  window_animation_duration 0.15 \
  window_animation_easing ease_in_out_cubic \
  insert_feedback_color 0xff50fa7b \
  window_zoom_persist on

# Mouse Configuration
yabai -m config focus_follows_mouse off \
  mouse_follows_focus off \
  mouse_modifier alt \
  mouse_action1 move \
  mouse_action2 resize \
  mouse_drop_action swap

# --- Jankyborders Management ------------------------------------------------
BORDERS_RC="${XDG_CONFIG_HOME:-$HOME/.config}/borders/bordersrc"
if ! pgrep -x borders >/dev/null 2>&1; then
  "$BORDERS_RC" >/dev/null 2>&1 &
fi

restart_borders() {
  if ! pgrep -x borders >/dev/null 2>&1; then
    "$BORDERS_RC" >/dev/null 2>&1 &
  fi
}

yabai -m signal --add label=restart_borders \
  event=application_terminated app="borders" \
  action="restart_borders"

yabai -m signal --add label=borders_on_dock_restart \
  event=dock_did_restart \
  action="restart_borders"

