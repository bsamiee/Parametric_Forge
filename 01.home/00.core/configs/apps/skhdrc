#!/usr/bin/env bash
# Title         : skhdrc
# Author        : Bardia Samiee
# Project       : Parametric Forge
# License       : MIT
# Path          : /01.home/00.core/configs/apps/skhdrc
# ----------------------------------------------------------------------------
# Unified hotkey configuration with conflict-free hierarchy
# shellcheck shell=bash
# shellcheck disable=SC2148
# shellcheck disable=SC2171,SC2288
# shellcheck disable=SC2154
# shellcheck disable=SC1089,SC2086

# --- BLACKLIST: Applications that should not receive skhd hotkeys -----------
# These apps handle their own keyboard shortcuts or need full keyboard access
.blacklist [
"1Password"
"secure keyboard entry"
"Activity Monitor"
"System Settings"
"System Preferences"
]

# --- TIER 1: Daily Operations (80% usage - Simple & Memorable) -------------
# Window focus with intuitive arrow keys - no app conflicts
ctrl + lalt - left : [
"WezTerm" ~
"Code" ~
"Visual Studio Code" ~
"IntelliJ IDEA" ~
"*" : "$HOME/.config/yabai/run-yabai.sh" -m window --focus west
]

ctrl + lalt - down : [
"WezTerm" ~
"Code" ~
"Visual Studio Code" ~
"IntelliJ IDEA" ~
"*" : "$HOME/.config/yabai/run-yabai.sh" -m window --focus south
]

ctrl + lalt - up : [
"WezTerm" ~
"Code" ~
"Visual Studio Code" ~
"IntelliJ IDEA" ~
"*" : "$HOME/.config/yabai/run-yabai.sh" -m window --focus north
]

ctrl + lalt - right : [
"WezTerm" ~
"Code" ~
"Visual Studio Code" ~
"IntelliJ IDEA" ~
"*" : "$HOME/.config/yabai/run-yabai.sh" -m window --focus east
]

# Display focus (left option to keep right option free)
lalt - s : "$HOME/.config/yabai/run-yabai.sh" -m display --focus west
lalt - g : "$HOME/.config/yabai/run-yabai.sh" -m display --focus east

# Workspace navigation (Super = ⌘⌥⌃ via Right Option)
cmd + ctrl + alt - 1 : "$HOME/.config/yabai/run-yabai.sh" -m space --focus 1
cmd + ctrl + alt - 2 : "$HOME/.config/yabai/run-yabai.sh" -m space --focus 2
cmd + ctrl + alt - 3 : "$HOME/.config/yabai/run-yabai.sh" -m space --focus 3
cmd + ctrl + alt - 4 : "$HOME/.config/yabai/run-yabai.sh" -m space --focus 4
cmd + ctrl + alt - 5 : "$HOME/.config/yabai/run-yabai.sh" -m space --focus 5
cmd + ctrl + alt - 6 : "$HOME/.config/yabai/run-yabai.sh" -m space --focus 6
cmd + ctrl + alt - 7 : "$HOME/.config/yabai/run-yabai.sh" -m space --focus 7
cmd + ctrl + alt - 8 : "$HOME/.config/yabai/run-yabai.sh" -m space --focus 8
cmd + ctrl + alt - 9 : "$HOME/.config/yabai/run-yabai.sh" -m space --focus 9

# Space cycling within current display
cmd + ctrl + alt - left : "$HOME/.config/yabai/run-yabai.sh" -m space --focus prev || "$HOME/.config/yabai/run-yabai.sh" -m space --focus last
cmd + ctrl + alt - right : "$HOME/.config/yabai/run-yabai.sh" -m space --focus next || "$HOME/.config/yabai/run-yabai.sh" -m space --focus first

# --- TIER 2: Essential Manual Overrides (SHIFT + OPT) ---------------------
# Core toggles when you need manual control over auto-balance
# Global padding/gap toggle with state coordination
shift + lalt - return : \
    current_padding="$("$HOME/.config/yabai/run-yabai.sh" -m config top_padding)"; \
    if [ "$current_padding" = "0" ]; then \
        "$HOME/.config/yabai/run-yabai.sh" -m config top_padding 4; \
        "$HOME/.config/yabai/run-yabai.sh" -m config bottom_padding 4; \
        "$HOME/.config/yabai/run-yabai.sh" -m config left_padding 4; \
        "$HOME/.config/yabai/run-yabai.sh" -m config right_padding 4; \
        "$HOME/.config/yabai/run-yabai.sh" -m config window_gap 4; \
    else \
        "$HOME/.config/yabai/run-yabai.sh" -m config top_padding 0; \
        "$HOME/.config/yabai/run-yabai.sh" -m config bottom_padding 0; \
        "$HOME/.config/yabai/run-yabai.sh" -m config left_padding 0; \
        "$HOME/.config/yabai/run-yabai.sh" -m config right_padding 0; \
        "$HOME/.config/yabai/run-yabai.sh" -m config window_gap 0; \
    fi
shift + lalt - space : "$HOME/.config/yabai/run-yabai.sh" -m window --toggle float --grid 4:4:1:1:2:2
shift + lalt - r : "$HOME/.config/yabai/run-yabai.sh" -m space --rotate 270 # Fix layout when messy

# Toggle mouse drop action between swap and stack (for drag-drop stacking)
shift + lalt - m : \
    current="$(\"$HOME/.config/yabai/run-yabai.sh\" -m config mouse_drop_action)"; \
    if [ "$current" = "swap" ]; then \
        "$HOME/.config/yabai/run-yabai.sh" -m config mouse_drop_action stack; \
    else \
        "$HOME/.config/yabai/run-yabai.sh" -m config mouse_drop_action swap; \
    fi

# --- TIER 3: Power Operations (Hyper = ⌘⌥⌃⇧ via Right Command) -------------
# Move window to workspace and follow (stable workspace numbers)
cmd + ctrl + alt + shift - 1 : "$HOME/.config/yabai/run-yabai.sh" -m window --space 1; "$HOME/.config/yabai/run-yabai.sh" -m space --focus 1
cmd + ctrl + alt + shift - 2 : "$HOME/.config/yabai/run-yabai.sh" -m window --space 2; "$HOME/.config/yabai/run-yabai.sh" -m space --focus 2
cmd + ctrl + alt + shift - 3 : "$HOME/.config/yabai/run-yabai.sh" -m window --space 3; "$HOME/.config/yabai/run-yabai.sh" -m space --focus 3
cmd + ctrl + alt + shift - 4 : "$HOME/.config/yabai/run-yabai.sh" -m window --space 4; "$HOME/.config/yabai/run-yabai.sh" -m space --focus 4
cmd + ctrl + alt + shift - 5 : "$HOME/.config/yabai/run-yabai.sh" -m window --space 5; "$HOME/.config/yabai/run-yabai.sh" -m space --focus 5
cmd + ctrl + alt + shift - 6 : "$HOME/.config/yabai/run-yabai.sh" -m window --space 6; "$HOME/.config/yabai/run-yabai.sh" -m space --focus 6
cmd + ctrl + alt + shift - 7 : "$HOME/.config/yabai/run-yabai.sh" -m window --space 7; "$HOME/.config/yabai/run-yabai.sh" -m space --focus 7
cmd + ctrl + alt + shift - 8 : "$HOME/.config/yabai/run-yabai.sh" -m window --space 8; "$HOME/.config/yabai/run-yabai.sh" -m space --focus 8
cmd + ctrl + alt + shift - 9 : "$HOME/.config/yabai/run-yabai.sh" -m window --space 9; "$HOME/.config/yabai/run-yabai.sh" -m space --focus 9

# (Removed) ralt fast-path: superseded by Super and Hyper mappings

# Window operations (Hyper)
cmd + ctrl + alt + shift - left  : "$HOME/.config/yabai/run-yabai.sh" -m window --swap west
cmd + ctrl + alt + shift - right : "$HOME/.config/yabai/run-yabai.sh" -m window --swap east
cmd + ctrl + alt + shift - down  : "$HOME/.config/yabai/run-yabai.sh" -m window --swap south
cmd + ctrl + alt + shift - up    : "$HOME/.config/yabai/run-yabai.sh" -m window --swap north
cmd + ctrl + alt + shift - h : "$HOME/.config/yabai/run-yabai.sh" -m window --resize left:-50:0 || "$HOME/.config/yabai/run-yabai.sh" -m window --resize right:-50:0
cmd + ctrl + alt + shift - l : "$HOME/.config/yabai/run-yabai.sh" -m window --resize right:50:0 || "$HOME/.config/yabai/run-yabai.sh" -m window --resize left:50:0
cmd + ctrl + alt + shift - j : "$HOME/.config/yabai/run-yabai.sh" -m window --resize bottom:0:50 || "$HOME/.config/yabai/run-yabai.sh" -m window --resize top:0:50
cmd + ctrl + alt + shift - k : "$HOME/.config/yabai/run-yabai.sh" -m window --resize top:0:-50 || "$HOME/.config/yabai/run-yabai.sh" -m window --resize bottom:0:-50

# Display management (Hyper)
cmd + ctrl + alt + shift - s : "$HOME/.config/yabai/run-yabai.sh" -m window --display west; "$HOME/.config/yabai/run-yabai.sh" -m display --focus west
cmd + ctrl + alt + shift - g : "$HOME/.config/yabai/run-yabai.sh" -m window --display east; "$HOME/.config/yabai/run-yabai.sh" -m display --focus east

# --- Window Stacking Operations -------------------------------------------
# Stack windows (create window stacks in BSP layout)
shift + lalt - w : "$HOME/.config/yabai/run-yabai.sh" -m window --stack north
shift + lalt - s : "$HOME/.config/yabai/run-yabai.sh" -m window --stack south
shift + lalt - a : "$HOME/.config/yabai/run-yabai.sh" -m window --stack west
shift + lalt - d : "$HOME/.config/yabai/run-yabai.sh" -m window --stack east

# Navigate within stacks (fallback to regular navigation)
lalt - n : "$HOME/.config/yabai/run-yabai.sh" -m window --focus stack.next || "$HOME/.config/yabai/run-yabai.sh" -m window --focus next
lalt - p : "$HOME/.config/yabai/run-yabai.sh" -m window --focus stack.prev || "$HOME/.config/yabai/run-yabai.sh" -m window --focus prev
lalt - 0x12 : "$HOME/.config/yabai/run-yabai.sh" -m window --focus stack.first || "$HOME/.config/yabai/run-yabai.sh" -m window --focus first  # key: 1
lalt - 0x13 : "$HOME/.config/yabai/run-yabai.sh" -m window --focus stack.last || "$HOME/.config/yabai/run-yabai.sh" -m window --focus last    # key: 2

# Insert stack point (prepare for stacking)
shift + lalt - i : "$HOME/.config/yabai/run-yabai.sh" -m window --insert stack

# Toggle space layout between BSP and Stack
shift + lalt - t : \
    PATH="/opt/homebrew/bin:/usr/local/bin:/run/current-system/sw/bin:$PATH"; \
    layout="$("$HOME/.config/yabai/run-yabai.sh" -m query --spaces --space | jq -r '.type')"; \
    if [ "$layout" = "bsp" ]; then \
        "$HOME/.config/yabai/run-yabai.sh" -m space --layout stack; \
    else \
        "$HOME/.config/yabai/run-yabai.sh" -m space --layout bsp; \
    fi

# --- Scratchpad Operations ----------------------------------------------
# Toggle scratchpad terminal (WezTerm with title "scratchpad")
lalt - grave : \
    pgrep -f "WezTerm.*scratchpad" >/dev/null 2>&1 && pkill -f "WezTerm.*scratchpad" || /Applications/WezTerm.app/Contents/MacOS/wezterm --config "window_background_opacity = 0.9" start --title scratchpad

# --- TIER 4: Expert Overrides (Hyper) --------------------------------------
# Space mirroring for layout corrections
cmd + ctrl + alt + shift - x : "$HOME/.config/yabai/run-yabai.sh" -m space --mirror x-axis
cmd + ctrl + alt + shift - y : "$HOME/.config/yabai/run-yabai.sh" -m space --mirror y-axis

# --- Utility Operations (Simple Keys) ---------------------------------------
# Quick navigation and space management
lalt - tab : "$HOME/.config/yabai/run-yabai.sh" -m space --focus recent || "$HOME/.config/yabai/run-yabai.sh" -m space --focus first

# Palettes
shift + lalt - p : open 'hammerspoon://forge/palette/main'

# Dynamic space management with display awareness
cmd + alt - n : \
    PATH="/opt/homebrew/bin:/usr/local/bin:/run/current-system/sw/bin:$PATH"; \
    "$HOME/.config/yabai/run-yabai.sh" -m space --create && \
    index=$("$HOME/.config/yabai/run-yabai.sh" -m query --spaces --display | jq 'map(select(.\"is-native-fullscreen\" == false))[-1].index') && \
    "$HOME/.config/yabai/run-yabai.sh" -m space --focus "$index"

cmd + alt - d : \
    PATH="/opt/homebrew/bin:/usr/local/bin:/run/current-system/sw/bin:$PATH"; \
    if [ "$("$HOME/.config/yabai/run-yabai.sh" -m query --spaces --display | jq 'map(select(.\"is-native-fullscreen\" == false)) | length')" -gt 1 ]; then \
        "$HOME/.config/yabai/run-yabai.sh" -m space --destroy; \
    fi

# Enhanced display focus (already exists as lalt - s/g, adding fallback support)
# Note: Basic window focus (lalt - arrows) defined in TIER 1 section above

# --- Hammerspoon Palettes (Window Chooser) ---------------------------------
cmd + alt - p : open -g "hammerspoon://forge/palette/windows"
cmd + alt - o : open -g "hammerspoon://forge/palette/windowsSpace"
cmd + alt - y : open -g "hammerspoon://forge/palette/main"
