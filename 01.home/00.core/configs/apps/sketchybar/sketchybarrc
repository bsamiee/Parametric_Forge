#!/bin/bash
# shellcheck disable=SC1091  # External config files
# Title         : sketchybarrc
# Author        : Bardia Samiee
# Project       : Parametric Forge
# License       : MIT
# Path          : /01.home/00.core/configs/apps/sketchybar/sketchybarrc
# ----------------------------------------------------------------------------
# Clean SketchyBar configuration with Dracula theme

set -e

# Ensure Homebrew tools (jq, blueutil, etc.) are on PATH for scripts
export PATH="/opt/homebrew/bin:/usr/local/bin:$PATH"

# --- Configuration ----------------------------------------------------------
source "$HOME/.config/sketchybar/colors.sh"
source "$HOME/.config/sketchybar/icons.sh"
source "$HOME/.config/sketchybar/constants.sh"

ITEM_DIR="$HOME/.config/sketchybar/items"
PLUGIN_DIR="$HOME/.config/sketchybar/plugins"

# --- Bar Configuration ------------------------------------------------------
bar=(
    height="$HEIGHT_BAR"
    color="$PRIMARY_BLACK"
    border_color="$PRIMARY_WHITE"
    border_width="$BORDER_THIN"
    shadow=on
    position=top
    sticky=on
    padding_right="$PADDINGS_XXLARGE"
    padding_left="$PADDINGS_XXLARGE"
    corner_radius="$RADIUS_LARGE"
    y_offset="$OFFSET_BAR"
    margin="$OFFSET_BAR"
    blur_radius="$BLUR_RADIUS_STANDARD"
    notch_width="$PADDINGS_NONE"
    notch_offset="$PADDINGS_NONE"
    font_smoothing=on
)

sketchybar --bar "${bar[@]}"

# --- Defaults ---------------------------------------------------------------
defaults=(
    updates=when_shown
    icon.font="$SYMBOL_FONT:$MEDIUM_WEIGHT:$SIZE_MEDIUM"
    icon.color="$WHITE"
    icon.padding_left="$PADDINGS_MEDIUM"
    icon.padding_right="$PADDINGS_MEDIUM"
    label.font="$TEXT_FONT:$REGULAR_WEIGHT:$SIZE_SMALL"
    label.color="$WHITE"
    label.padding_left="$PADDINGS_MEDIUM"
    label.padding_right="$PADDINGS_MEDIUM"
    padding_right="$PADDINGS_MEDIUM"
    padding_left="$PADDINGS_MEDIUM"
    background.height="$HEIGHT_ITEM"
    background.corner_radius="$RADIUS_LARGE"
    popup.background.border_width="$PADDINGS_NONE"
    popup.background.corner_radius="$RADIUS_MEDIUM"
    popup.background.border_color="$TRANSPARENT"
    popup.background.color="$PRIMARY_BLACK"
    popup.blur_radius="$PADDINGS_NONE"
    popup.background.shadow.drawing=on
)

sketchybar --default "${defaults[@]}"

# --- Events -----------------------------------------------------------------
# Define custom events to avoid colliding with built-ins
sketchybar --add event pf_space_change \
    --add event pf_window_focus

# --- Left Items -------------------------------------------------------------
source "$ITEM_DIR/logo.sh" || true
source "$ITEM_DIR/menu-items.sh" || true
source "$ITEM_DIR/spaces.sh" || true

# Add spaces separator using helper
source "$HOME/.config/sketchybar/helpers/separator.sh" || true
add_separator "spaces" left "chevron_right" || true

source "$ITEM_DIR/focus_app.sh" || true

# --- Invisible Event Handlers -----------------------------------------------
# These items handle events but don't display anything
sketchybar --add item window_state right \
    --set window_state drawing=off \
    script="$PLUGIN_DIR/window_state.sh" \
    --subscribe window_state pf_window_focus front_app_switched

sketchybar --add item space_events right \
    --set space_events drawing=off \
    script="$ITEM_DIR/spaces.sh" \
    --subscribe space_events space_change pf_space_change space_windows_change

# --- Right Items ------------------------------------------------------------
source "$ITEM_DIR/wifi.sh" || true
source "$ITEM_DIR/system-monitor.sh" || true
source "$ITEM_DIR/mic.sh" || true
source "$ITEM_DIR/volume.sh" || true
source "$ITEM_DIR/bluetooth.sh" || true
source "$ITEM_DIR/battery.sh" || true
source "$ITEM_DIR/calendar.sh" || true

# Desired visual order (left -> right on the right side):
# system_monitor -> wifi -> bluetooth -> mic -> volume -> battery -> calendar
# Note: For right-positioned items, "after" places the item visually to the left of the reference.
# Place system monitor to the left of wifi if present, else to the left of bluetooth.
sketchybar --move system_monitor before wifi 2>/dev/null || true
sketchybar --move system_monitor before bluetooth 2>/dev/null || true
sketchybar --move battery after calendar 2>/dev/null || true
sketchybar --move volume  after battery  2>/dev/null || true
sketchybar --move mic     after volume   2>/dev/null || true
sketchybar --move bluetooth after mic    2>/dev/null || true
sketchybar --move wifi      after bluetooth 2>/dev/null || true

# --- Initialize State -------------------------------------------------------
# Proactively initialize spaces and window state to avoid race conditions
# with yabai/launchd ordering on boot.

# 1) Ensure spaces are created and bracketed even if yabai hasn't triggered yet
SENDER=pf_space_change "$ITEM_DIR/spaces.sh" >/dev/null 2>&1 || true

# 2) Initialize window-focused app and window state visuals
"$PLUGIN_DIR/window_state.sh" >/dev/null 2>&1 || true

# 3) Fire synthetic events so per-space scripts can compute labels/icons
sketchybar --trigger pf_space_change --trigger pf_window_focus || true

# 4) Final update pass
sketchybar --update

# Guard: clear any accidental initial hover state on calendar bracket
sketchybar --set calendar_group background.drawing=off 2>/dev/null || true

# Smooth out early battery state transitions (e.g., chargingâ†’charged)
# by doing a one-shot refresh shortly after startup.
(sleep 2; "$PLUGIN_DIR"/battery.sh >/dev/null 2>&1 || true) &
