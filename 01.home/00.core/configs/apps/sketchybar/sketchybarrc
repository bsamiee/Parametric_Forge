#!/bin/bash
# shellcheck disable=SC1091  # External config files
# Title         : sketchybarrc
# Author        : Bardia Samiee
# Project       : Parametric Forge
# License       : MIT
# Path          : /01.home/00.core/configs/apps/sketchybar/sketchybarrc
# ----------------------------------------------------------------------------
# Clean SketchyBar configuration with Dracula theme

set -euo pipefail

# --- Configuration ----------------------------------------------------------
source "$HOME/.config/sketchybar/colors.sh"
source "$HOME/.config/sketchybar/icons.sh"
source "$HOME/.config/sketchybar/constants.sh"

ITEM_DIR="$HOME/.config/sketchybar/items"
PLUGIN_DIR="$HOME/.config/sketchybar/plugins"

# --- Bar Configuration ------------------------------------------------------
bar=(
    height="$HEIGHT_BAR"
    color="$PRIMARY_BLACK"
    border_color="$PRIMARY_WHITE"
    border_width="$BORDER_THIN"
    shadow=on
    shadow.color="$SHADOW_HEAVY"
    shadow.angle="$SHADOW_ANGLE"
    shadow.distance="$SHADOW_DISTANCE"
    position=top
    sticky=on
    padding_right="$PADDINGS_XXLARGE"
    padding_left="$PADDINGS_MEDIUM"
    corner_radius="$RADIUS_LARGE"
    y_offset="$OFFSET_BAR"
    margin="$OFFSET_BAR"
    blur_radius="$BLUR_RADIUS_STANDARD"
    notch_width="$PADDINGS_NONE"
    notch_offset="$PADDINGS_NONE"
    font_smoothing=on
)

sketchybar --bar "${bar[@]}"

# --- Defaults ---------------------------------------------------------------
defaults=(
    updates=when_shown
    icon.font="$SYMBOL_FONT:$MEDIUM_WEIGHT:$SIZE_MEDIUM"
    icon.color="$WHITE"
    icon.padding_left="$PADDINGS_MEDIUM"
    icon.padding_right="$PADDINGS_MEDIUM"
    label.font="$TEXT_FONT:$REGULAR_WEIGHT:$SIZE_SMALL"
    label.color="$WHITE"
    label.padding_left="$PADDINGS_MEDIUM"
    label.padding_right="$PADDINGS_MEDIUM"
    padding_right="$PADDINGS_MEDIUM"
    padding_left="$PADDINGS_MEDIUM"
    background.height="$HEIGHT_ITEM"
    background.corner_radius="$RADIUS_LARGE"
    popup.background.border_width="$PADDINGS_NONE"
    popup.background.corner_radius="$RADIUS_MEDIUM"
    popup.background.border_color="$TRANSPARENT"
    popup.background.color="$PRIMARY_BLACK"
    popup.blur_radius="$PADDINGS_NONE"
    popup.background.shadow.drawing=on
)

sketchybar --default "${defaults[@]}"

# --- Events -----------------------------------------------------------------
sketchybar --add event space_change \
    --add event windows_on_spaces \
    --add event window_focus

# --- Left Items (Logo → Menu → Spaces → Front App) -----------------------
source "$ITEM_DIR/logo.sh"
source "$ITEM_DIR/menu-items.sh"

# Add separator between menu and spaces
source "$HOME/.config/sketchybar/helpers/separator.sh"
add_separator "menu_to_spaces" left "line"

source "$ITEM_DIR/spaces.sh"

# Add separator between spaces and front_app
add_separator "spaces_to_front_app" left "chevron_right"

source "$ITEM_DIR/front_app.sh"

# --- Window State Integration -----------------------------------------------
# Lightweight window state monitoring (from yabai.sh functionality)
sketchybar --add item window_state left \
    --set window_state drawing=off \
    script="$PLUGIN_DIR/window_state.sh" \
    --subscribe window_state window_focus

# --- Space Event Integration ------------------------------------------------
# Direct space event handling (no routing through window logic)
sketchybar --add item space_events left \
    --set space_events drawing=off \
    script="$ITEM_DIR/spaces.sh" \
    --subscribe space_events windows_on_spaces space_change

# --- Right Items -----------------------------------------------------------
source "$ITEM_DIR/calendar.sh"
# source "$ITEM_DIR/music.sh"
# source "$ITEM_DIR/system-monitor.sh"
# source "$ITEM_DIR/volume.sh"
# source "$ITEM_DIR/battery.sh"
# source "$ITEM_DIR/wifi.sh"
# source "$ITEM_DIR/bluetooth.sh"
# source "$ITEM_DIR/mic.sh"
# source "$ITEM_DIR/notifications.sh"
# source "$ITEM_DIR/packages.sh"
# source "$ITEM_DIR/controls.sh"
# source "$ITEM_DIR/control-center.sh"
# source "$ITEM_DIR/calendar.sh"

# --- Initialize -------------------------------------------------------------
sketchybar --update
